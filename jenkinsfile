pipeline {
    agent any
   
    environment {
        // Repository configuration
        GIT_URL = 'https://github.com/codewithbab015/fnb-dataquest-recosys.git'
        GIT_CREDENTIALS_ID = 'jenkins_access_id'
       
        // MLOps tool configurations
        MLFLOW_TRACKING_URI = 'http://mlflow-server:5000'
        // Docker Hub configuration
        DOCKERHUB_CREDENTIALS_ID = 'docker_access_id'
        DOCKER_USERNAME = 'mrbaloyin'
        DOCKER_IMG = 'recosys-model' //Change the name of the image tag as needed
        VERSION = 'latest'
        // Python environment
        PIP_CACHE_DIR = "${WORKSPACE}/.pip_cache"
        VENV_DIR = "${WORKSPACE}/.venv"
    }
    
    stages {
        stage("üîÑ Source Control") {
            steps {
                script {
                    // Load utils library
                    def utilsLib = load "jenkins/utils.groovy"
                    
                    // Clone repository
                    utilsLib.cloneRepository(env.GIT_URL, env.GIT_CREDENTIALS_ID)
                
                }
                sh '''
                    echo "‚úÖ Repository cloned successfully"
                    echo "üìä Commit: $(git rev-parse HEAD)"
                    echo "üåø Branch: $(git branch --show-current)"
                '''
            }
        }
       
        stage("üêç Setup Python Environment") {
            steps {
                script {
                    // Reload utils library (necessary for each stage)
                    def utilsLib = load "jenkins/utils.groovy"
                    utilsLib.pythonEnvironment(env.VENV_DIR)
                }
            }
        }
    }
   
    post {
        always {
            script {
                // Archive artifacts only if they exist
                if (fileExists('reports/')) {
                    archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                }
                if (fileExists('models/')) {
                    archiveArtifacts artifacts: 'models/**/*', allowEmptyArchive: true
                }
                
                // Publish test results if they exist
                if (fileExists('**/test-results.xml')) {
                    publishTestResults testResultsPattern: '**/test-results.xml'
                } else {
                    echo "üü° No test result files found, skipping test results publishing"
                }
                
                // Publish coverage if it exists
                if (fileExists('coverage.xml')) {
                    publishCoverage adapters: [coberturaAdapter('coverage.xml')]
                } else {
                    echo "üü° No coverage report found, skipping coverage publishing"
                }
            }
            sh '''
                echo "üßπ Cleaning up workspace"
                # Remove virtual environment
                rm -rf venv || true
                # Clean up pip cache
                rm -rf ${PIP_CACHE_DIR} || true
            '''
        }
       
        success {
            echo "‚úÖ Pipeline completed successfully!"
            sh '''
                echo "üìß Sending success notification"
                # Add your notification logic here
                # python src/notifications/send_notification.py --status=success
            '''
        }
       
        failure {
            echo "‚ùå Pipeline failed!"
            sh '''
                echo "üìß Sending failure notification"
                # Add your notification logic here
                # python src/notifications/send_notification.py --status=failure
            '''
        }
       
        unstable {
            echo "‚ö†Ô∏è Pipeline completed with warnings"
            sh '''
                echo "üìß Sending warning notification"
                # Add your notification logic here
                # python src/notifications/send_notification.py --status=warning
            '''
        }
    }
}